# Enterprise Public Servers

This test mimics the configuration of an enterprise firewall used as *front-end* device, which controls the traffic directed to a protected network (e.g., `DMZ`) that hosts a set of servers that must be reachable from the outside world.
We increase the number of public servers that needs to be protected, hence tests were repeated with different number of rules.

## Rule-sets

The rule-sets used for this tests can be found in the [rulsets](./rulesets) folder.
The first rule *accepts* all the `ESTABLISHED` connections towards the protected network; then, a set of rules *accept* `NEW` connections generated by the servers in the protected network toward the outside world; the latest set of rules enable the communication towards the services exposed in the protected network by matching on the destination IP, protocol and L4 port destination of the incoming packets.
Among the different runs we used an increasing number of rules ranging from 50 to 5K, depending on the number of public services that are exposed to the outside world.

## Test description

All the rules are loaded in the `FORWARD` chain and the traffic is generated so that the 90% is evenly distributed among all the rules and the 10% matches the default `DROP` rule.
The packet generator is connected to the DUT through two interfaces, simulating a scenario where the firewall is in between the two (public and protected) networks.
In particular, the first interface simulates the traffic coming from the external network i.e., a set of clients contacting the internal services, while the second interface simulates a response from the internal services to the clients.
For this reason, during this test, when the traffic coming from the external and the internal network reaches the firewall, it considers all the connection as `ESTABLISHED`, hence matching the first rule of the ruleset, which represents a common scenario in an enterprise network.

### Setup

The packet generator and the DUT should be connected each other through an XDP-compatible NIC. In particular, the first interface of the generator is connected to the first interface of the DUT and the same for the second interface (which are configured accordingly in the following scripts).
Both interfaces of the generator should be attached to DPDK so that `pktgen-dpdk` can be used to generate the traffic.

In addition, both machine should be able to communicate at IP level through an additional interface. The IP addresses of those interface should be configured in the following scripts.

### Scripts

This folder contains a single script [run-tests](./run-tests.sh) that is used to execute the test.

Both scripts can be configurable by passing the correct parameters through the command line, for example:

```bash
$ ./run-tests.sh -h
run-tests.sh [-h] [-r #runs] [-o output_file] [-i|-n]

where:
    -h  show this help text
    -r  number of runs for the test
    -o  path to file where the results are placed
    -i  use iptables
    -n  use nftables
```

In addition, you should modify the script with the correct IP addresses and folders used in your environment. The parameters that should be set are the following:

```bash
# Remote configurations (DUT)
REMOTE_DUT=1.1.1.1 (IP Address of the DUT)
REMOTE_FOLDER="~/bpf-iptables-tests/realistic-scenarios/enterprise-public-servers"
DST_MAC_IF0="3cfd:feaf:ec30" (MAC of the receiver interface of the DUT)
DST_MAC_IF1="3cfd:feaf:ec31" (MAC of the sender interface of the DUT)
INGRESS_IFACE_NAME="enp101s0f0" (Name of the receiver interface of the DUT)
EGRESS_IFACE_NAME="enp101s0f1" (Name of the sender interface of the DUT)

# Local configurations (Pkt generator)
PKTGEN_FOLDER="$HOME/dev/pktgen-dpdk"
LOCAL_NAME=cube1 (Name of the user in the pkt generator machine)
LOCAL_DUT=IPADDRESS (IP address of the pkt generator machine)
```

For example, to execute a single run of the multi-core test using bpf-iptables you should execute the following command:

```bash
$ ./run-tests.sh -r 1 -o bpf-iptables-results
```

